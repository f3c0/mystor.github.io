<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Nika's Box, Random stuff in C++ and Rust.">

        <link rel="alternate"  href="https://mystor.github.io/feeds/all.atom.xml" type="application/atom+xml" title="Nika's Box Full Atom Feed"/>
        <link rel="alternate" href="https://mystor.github.io/feeds/all.rss.xml" type="application/rss+xml" title="Nika's Box Full RSS Feed"/>

        <title>NIKA:\python-codegen\></title>


    <link rel="stylesheet" href="https://mystor.github.io/theme/css/nika2k.css">
    <!-- silly twitter stuff 'cause why not -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@kneecaw">
    <meta name="twitter:title" content="Python Codegen">
    <meta name="twitter:description" content="NIKA:\python-codegen\> _">

    <!-- gotta have that nice syntax highlighting~ -->
    <link rel="stylesheet" href="https://mystor.github.io/theme/css/pygments.css">
</head>

<body>
    <div id="layout">
        <div class="content">
            <h1 class="content-subhead">
                <a class="post-category" href="https://mystor.github.io">NIKA:\</a><a href="#" class="post-category">python-codegen\</a>>
                <span class="command">list</span>
            </h1>

    <section class="post">
        <header class="post-header">
            <h1>Python Codegen</h1>
            <p class="post-meta">
                Mon 22 October 2018 &middot;                     <a class="post-category" href="https://mystor.github.io/tag/python.html">python</a>
                    <a class="post-category" href="https://mystor.github.io/tag/codegen.html">codegen</a>
                    <a class="post-category" href="https://mystor.github.io/tag/mozilla.html">mozilla</a>
                    <a class="post-category" href="https://mystor.github.io/tag/webidl.html">webidl</a>
                    <a class="post-category" href="https://mystor.github.io/tag/xpidl.html">xpidl</a>
                    <a class="post-category" href="https://mystor.github.io/tag/ipdl.html">ipdl</a>
            </p>
        </header>
    </section>
    <p>One of the things I often find myself working on at Mozilla are our code
generators. We have a good number of code generators across our codebase,
which generate C++ or Rust code at build time. These include <a href="https://searchfox.org/mozilla-central/rev/0ec9f5972ef3e4a479720630ad7285a03776cdfc/xpcom/idl-parser/xpidl/header.py">xpidl</a>,
<a href="https://searchfox.org/mozilla-central/rev/0ec9f5972ef3e4a479720630ad7285a03776cdfc/dom/bindings/Codegen.py">webidl</a>, <a href="https://searchfox.org/mozilla-central/rev/0ec9f5972ef3e4a479720630ad7285a03776cdfc/ipc/ipdl/ipdl/lower.py">ipdl</a>, <a href="https://searchfox.org/mozilla-central/rev/0ec9f5972ef3e4a479720630ad7285a03776cdfc/xpcom/base/ErrorList.py">nserror</a>, <a href="https://searchfox.org/mozilla-central/rev/0ec9f5972ef3e4a479720630ad7285a03776cdfc/xpcom/reflect/xptinfo/xptcodegen.py">xptcodegen</a>, and more.</p>
<p>For the most part, these code generators are written with Python (2.7), as
that is the best supported scripting language in our build system (given that
mozbuild is writtn in python itself). However, despite this common language,
none of these generators share a common codegen helper library, and instead
hand-roll their own string formatting, indentation logic, etc.</p>
<p>As Firefox grows more processes, we are tending toward more code generators.
These allow us to move state which used to be dynamic into generated C++ code
which can be easily shared between processes. For example, the <a href="https://searchfox.org/mozilla-central/rev/0ec9f5972ef3e4a479720630ad7285a03776cdfc/xpcom/reflect/xptinfo/xptcodegen.py">xptcodegen</a>
generator was added to, in part, avoid the overhead of parsing xpt files at
runtime.</p>
<p>For this reason, I feel we should grow a utility library for building these
code generators. In the interest of aiming towards this, I want to explore
some of the designs taken in our codebase, and elsewhere.</p>
<h1>New-style '.format'</h1>
<div class="highlight"><pre><span></span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    {type} SomeCode({args}) {{</span>
<span class="s2">        return {value};</span>
<span class="s2">    }}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
</pre></div>


<p>The first option is to use the "new-style" string formatters. Unfortunately,
this doesn't work very well for generating C++ code.</p>
<ul>
<li>All <code>{</code> must be double-escaped, which is inconvenient.</li>
<li>Explicit call to <code>textwrap.dedent</code> is required for multiline strings.</li>
<li>Relatively easy to understand.</li>
<li>Fairly uncommon within the mozilla codebase.</li>
<li>Manual multiline indenting.</li>
</ul>
<h1>% Formatting</h1>
<div class="highlight"><pre><span></span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    </span><span class="si">%(type)s</span><span class="s2"> SomeCode(</span><span class="si">%(args)s</span><span class="s2">) {</span>
<span class="s2">        return </span><span class="si">%(value)s</span><span class="s2">;</span>
<span class="s2">    }</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
    <span class="p">}</span>
</pre></div>


<p>The most commonly used option used is the old-style <code>%</code> formatting. This has the advantage of </p>
<h1>XPTCodegen</h1>
<h1>WebIDL</h1>

<footer class="footer">
    <h1 class="content-subhead">About Nika</h1>
    <p>
        <strong>Nika Layzell</strong> is a platform engineer working on Gecko, the engine powering
        <a href="https://firefox.com/">Firefox</a>.<br> In her spare time, she
        makes a fool of herself on the internet, and breaks otherwise functional
        software.
    </p>
    <p>
        <a href="https://github.com/mystor/">github\</a> &middot;
        <a href="https://twitter.com/kneecaw/">twitter\</a> &middot;
        <a href="https://mystor.github.io/archives.html">archives\</a> &middot;
        <a href="https://mystor.github.io/categories.html">categories\</a> &middot;
        <a href="https://mystor.github.io/tags.html">tags\</a> &middot;
        <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a>
    </p>
</footer>        </div>
    </div>
</body>
</html>